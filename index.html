<!DOCTYPE html>
<html lang="en" data-theme="light"> <!-- Default theme attribute -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Required Head Content -->
    <title>Kami</title>
    <link rel="icon" href="https://web.kamihq.com/web/images/icon19.png" type="image/png">
    <!-- End Required Head Content -->

    <style>
        /* --- CSS Variables (Themes) --- */
        :root {
            /* Default: Light Theme */
            --bg-color: #f0f2f5;
            --text-color: #24292e;
            --secondary-text-color: #586069;
            --input-bg: #ffffff;
            --input-border: #d1d5da;
            --placeholder-color: #aaa;
            --primary-btn-bg: #007bff;
            --primary-btn-text: #ffffff;
            --primary-btn-hover-bg: #0056b3;
            --primary-btn-active-bg: #004085;
            --secondary-btn-bg: rgba(40, 40, 40, 0.8);
            --secondary-btn-text: #ffffff;
            --secondary-btn-hover-bg: rgba(0, 0, 0, 1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --iframe-bg: #ffffff;
            --selector-bg: #ffffff;
            --selector-border: #d1d5da;
            --selector-text: #24292e;
            --link-color: #0366d6; /* Example link color */
        }

        html[data-theme="dark"] {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --secondary-text-color: #cccccc;
            --input-bg: #3c3c3c;
            --input-border: #555555;
            --placeholder-color: #888888;
            --primary-btn-bg: #0e639c;
            --primary-btn-text: #ffffff;
            --primary-btn-hover-bg: #1177bb;
            --primary-btn-active-bg: #158bcd;
            --secondary-btn-bg: rgba(200, 200, 200, 0.7);
            --secondary-btn-text: #1e1e1e;
            --secondary-btn-hover-bg: rgba(230, 230, 230, 0.9);
            --shadow-color: rgba(255, 255, 255, 0.05);
            --iframe-bg: #252526;
            --selector-bg: #3c3c3c;
            --selector-border: #555555;
            --selector-text: #d4d4d4;
            --link-color: #4e94ce;
        }

        html[data-theme="vscode-dark-plus"] {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --secondary-text-color: #a0a0a0;
            --input-bg: #3c3c3c;
            --input-border: #3c3c3c;
            --placeholder-color: #7f7f7f;
            --primary-btn-bg: #0e639c; /* VS Code blue */
            --primary-btn-text: #ffffff;
            --primary-btn-hover-bg: #1177bb;
            --primary-btn-active-bg: #158bcd;
            --secondary-btn-bg: rgba(180, 180, 180, 0.7);
            --secondary-btn-text: #1e1e1e;
            --secondary-btn-hover-bg: rgba(210, 210, 210, 0.9);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --iframe-bg: #1e1e1e;
            --selector-bg: #3c3c3c;
            --selector-border: #3c3c3c;
            --selector-text: #d4d4d4;
            --link-color: #4e94ce;
        }

        html[data-theme="monokai"] {
            --bg-color: #272822;
            --text-color: #f8f8f2;
            --secondary-text-color: #a9a9a9;
            --input-bg: #3e3d32;
            --input-border: #5b5a4e;
            --placeholder-color: #9e9e9e;
            --primary-btn-bg: #ae81ff; /* Purple accent */
            --primary-btn-text: #272822;
            --primary-btn-hover-bg: #be95ff;
            --primary-btn-active-bg: #cfadff;
            --secondary-btn-bg: rgba(200, 200, 200, 0.7);
            --secondary-btn-text: #272822;
            --secondary-btn-hover-bg: rgba(230, 230, 230, 0.9);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --iframe-bg: #272822;
            --selector-bg: #3e3d32;
            --selector-border: #5b5a4e;
            --selector-text: #f8f8f2;
            --link-color: #66d9ef; /* Cyan */
        }

         html[data-theme="solarized-light"] {
            --bg-color: #fdf6e3; /* Base */
            --text-color: #657b83; /* Body text */
            --secondary-text-color: #93a1a1; /* Comments / Secondary */
            --input-bg: #eee8d5; /* Base1 */
            --input-border: #93a1a1;
            --placeholder-color: #93a1a1;
            --primary-btn-bg: #268bd2; /* Blue */
            --primary-btn-text: #fdf6e3;
            --primary-btn-hover-bg: #1a6a9e;
            --primary-btn-active-bg: #0f4c75;
            --secondary-btn-bg: rgba(88, 110, 117, 0.8); /* Base01 */
            --secondary-btn-text: #fdf6e3;
            --secondary-btn-hover-bg: rgba(40, 50, 55, 1);
            --shadow-color: rgba(0, 0, 0, 0.08);
            --iframe-bg: #fdf6e3;
            --selector-bg: #eee8d5;
            --selector-border: #93a1a1;
            --selector-text: #657b83;
            --link-color: #2aa198; /* Cyan */
        }

        html[data-theme="solarized-dark"] {
            --bg-color: #002b36; /* Base03 */
            --text-color: #839496; /* Base0 */
            --secondary-text-color: #586e75; /* Base01 Comments */
            --input-bg: #073642; /* Base02 */
            --input-border: #586e75;
            --placeholder-color: #586e75;
            --primary-btn-bg: #268bd2; /* Blue */
            --primary-btn-text: #fdf6e3; /* Light text on blue */
            --primary-btn-hover-bg: #1f7bbd;
            --primary-btn-active-bg: #1a6a9e;
            --secondary-btn-bg: rgba(147, 161, 161, 0.7); /* Base00 */
            --secondary-btn-text: #002b36; /* Dark text */
            --secondary-btn-hover-bg: rgba(180, 190, 190, 0.9);
            --shadow-color: rgba(255, 255, 255, 0.05);
            --iframe-bg: #002b36;
            --selector-bg: #073642;
            --selector-border: #586e75;
            --selector-text: #839496;
            --link-color: #2aa198; /* Cyan */
        }


        /* --- Base Styles using Variables --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease; /* Theme change transition */
        }
        a { color: var(--link-color); } /* Style links */

        /* --- Search Area --- */
        #search-container {
            display: flex;
            flex-direction: column; /* Stack search box and theme selector */
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s;
            opacity: 1;
            visibility: visible;
        }
        #search-box {
            display: flex;
            width: 100%;
            max-width: 600px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 25px;
            box-shadow: 0 5px 15px var(--shadow-color);
            overflow: hidden;
            margin-bottom: 20px; /* Space between search and theme selector */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #url-input {
            flex-grow: 1;
            padding: 15px 20px;
            font-size: 1em;
            border: none;
            outline: none;
            background-color: transparent; /* Inherits from #search-box */
            color: var(--text-color);
        }
        #url-input::placeholder {
            color: var(--placeholder-color);
            opacity: 1; /* Ensure placeholder is visible */
        }
        #submit-search-button {
            padding: 0 25px; /* Adjusted padding to align height */
            font-size: 1em;
            font-weight: 500;
            color: var(--primary-btn-text);
            background-color: var(--primary-btn-bg);
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            white-space: nowrap;
            line-height: 50px; /* Match input height roughly */
            height: 50px; /* Explicit height */
        }
        #submit-search-button:hover { background-color: var(--primary-btn-hover-bg); }
        #submit-search-button:active { background-color: var(--primary-btn-active-bg); }

        /* --- Theme Selector --- */
        #theme-selector {
            padding: 8px 12px;
            font-size: 0.9em;
            border-radius: 6px;
            border: 1px solid var(--selector-border);
            background-color: var(--selector-bg);
            color: var(--selector-text);
            cursor: pointer;
            outline: none;
             -webkit-appearance: none; /* Remove default OS styling */
            -moz-appearance: none;
            appearance: none;
             /* Add custom arrow indicator maybe */
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${(!!document.documentElement.dataset.theme && document.documentElement.dataset.theme !== 'light') ? 'cccccc' : '586069' /* Crude way to change arrow color, better via var */}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 10px auto;
            padding-right: 30px; /* Space for arrow */
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        #theme-selector:hover {
             border-color: var(--primary-btn-bg); /* Highlight on hover */
        }


        /* --- Iframe & Controls --- */
        #iframe-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            visibility: hidden; opacity: 0;
            transition: opacity 0.4s ease-in-out, visibility 0s linear 0.4s;
            z-index: 1000;
            background-color: var(--iframe-bg); /* Use variable */
        }
        #iframe-container.visible { visibility: visible; opacity: 1; transition: opacity 0.4s ease-in-out; }
        #content-iframe {
            width: 100%; height: 100%; border: none;
            background-color: var(--iframe-bg); /* Use variable */
        }
        #close-button {
            position: fixed; top: 15px; right: 15px; width: 35px; height: 35px;
            background-color: var(--secondary-btn-bg);
            color: var(--secondary-btn-text);
            border: none; border-radius: 50%;
            font-size: 20px; font-weight: bold; line-height: 35px; text-align: center;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, opacity 0.3s ease, visibility 0s linear 0.3s;
            z-index: 1001;
            visibility: hidden; opacity: 0;
        }
        #iframe-container.visible #close-button { visibility: visible; opacity: 1; transition: opacity 0.3s ease-in-out 0.2s, visibility 0s linear 0s, background-color 0.2s ease, color 0.2s ease; }
        #close-button:hover { background-color: var(--secondary-btn-hover-bg); }
        #close-button:active { transform: scale(0.95); }

        /* --- Panic Mode Styles --- */
        body.panic-active #search-container {
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 0.1s ease, visibility 0s linear 0.1s;
        }
        body.panic-active #iframe-container {
            visibility: visible; opacity: 1;
            transition: none !important;
        }
        body.panic-active #close-button { display: none !important; }

    </style>
</head>
<body>
    <!-- DOC_CONTENT_START -->

    <div id="search-container">
        <div id="search-box">
            <input type="text" id="url-input" placeholder="Enter URL (e.g., https://wikipedia.org)">
            <button id="submit-search-button">Search</button>
        </div>
        <div id="theme-controls">
             <label for="theme-selector" style="margin-right: 8px; font-size: 0.9em; color: var(--secondary-text-color);">Theme:</label>
             <select id="theme-selector">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
                <option value="vscode-dark-plus">VSCode Dark+</option>
                <option value="monokai">Monokai</option>
                <option value="solarized-light">Solarized Light</option>
                <option value="solarized-dark">Solarized Dark</option>
            </select>
        </div>
    </div>

    <div id="iframe-container">
        <button id="close-button" title="Close">×</button>
        <iframe id="content-iframe" src="about:blank" frameborder="0" allowfullscreen></iframe>
    </div>

     <!-- DOC_CONTENT_END -->

    <script>
        // --- Constants ---
        const PANIC_URL = "https://web.kamihq.com/web/viewer.html";
        const PANIC_STORAGE_KEY = 'isInPanicMode';
        const THEME_STORAGE_KEY = 'selectedTheme'; // Key for theme preference
        const UPDATE_URL = "https://raw.githubusercontent.com/H644b/UpdatesforSecret/main/index.html";
        const UPDATE_HASH_FLAG = '#updated';

        // --- DOM Elements ---
        let searchContainer, searchBox, urlInput, submitSearchButton, iframeContainer, contentIframe, closeButton, bodyElement, themeSelector;

        function getElements() {
            searchContainer = document.getElementById('search-container');
            searchBox = document.getElementById('search-box');
            urlInput = document.getElementById('url-input');
            submitSearchButton = document.getElementById('submit-search-button');
            iframeContainer = document.getElementById('iframe-container');
            contentIframe = document.getElementById('content-iframe');
            closeButton = document.getElementById('close-button');
            bodyElement = document.body;
            themeSelector = document.getElementById('theme-selector'); // Get theme selector
        }


        // --- Update Function (Async) ---
        async function checkForUpdates() {
            if (window.location.hash === UPDATE_HASH_FLAG) {
                console.log("Update applied, skipping check.");
                 if (history.replaceState) history.replaceState(null, '', window.location.pathname + window.location.search);
                return;
            }
            console.log("Checking for updates...");
            try {
                const response = await fetch(UPDATE_URL, { cache: 'no-store' });
                if (!response.ok) throw new Error(`Fetch failed: ${response.status}`);
                const newHtmlText = await response.text();
                const currentHtmlText = document.documentElement.outerHTML;

                if (newHtmlText && newHtmlText.trim() !== currentHtmlText.trim()) {
                    console.log("Update found! Applying...");
                    const blob = new Blob([newHtmlText], { type: 'text/html' });
                    const objectUrl = URL.createObjectURL(blob);
                    window.location.replace(objectUrl + UPDATE_HASH_FLAG);
                    // Script stops here due to navigation
                } else {
                    console.log("No update needed.");
                }
            } catch (error) {
                console.log("Update check failed (maybe offline?).", error);
            }
        }

        // --- Theme Functions ---
        function applyTheme(themeName) {
            console.log("Applying theme:", themeName);
            if (!themeName) themeName = 'light'; // Default to light if null/undefined
            document.documentElement.setAttribute('data-theme', themeName);

            // Update the selector dropdown to match the applied theme
            if (themeSelector) {
                 themeSelector.value = themeName;
            }
        }

        function saveTheme(themeName) {
             try {
                localStorage.setItem(THEME_STORAGE_KEY, themeName);
             } catch (e) {
                 console.error("LocalStorage unavailable. Theme preference won't be saved.", e);
             }
        }

        // --- Panic Mode & Core App Functions ---
        function enterPanicMode() {
            if (!contentIframe || !bodyElement || !localStorage || !searchContainer || !iframeContainer) return;
            console.log("Entering Panic Mode");
            contentIframe.src = PANIC_URL;
            bodyElement.classList.add('panic-active');
            try { localStorage.setItem(PANIC_STORAGE_KEY, 'true'); } catch (e) { console.error("LocalStorage unavailable.", e); }
            searchContainer.style.opacity = '0'; searchContainer.style.visibility = 'hidden'; searchContainer.style.pointerEvents = 'none';
            iframeContainer.classList.add('visible');
        }

        function exitPanicMode() {
             if (!bodyElement || !localStorage || !iframeContainer || !contentIframe || !searchContainer) return;
             console.log("Exiting Panic Mode");
             try { localStorage.removeItem(PANIC_STORAGE_KEY); } catch (e) { console.error("LocalStorage unavailable.", e); }
             bodyElement.classList.remove('panic-active');
             iframeContainer.classList.remove('visible');
             contentIframe.src = 'about:blank';
             searchContainer.style.opacity = '1'; searchContainer.style.visibility = 'visible'; searchContainer.style.pointerEvents = 'auto';
        }

        function showRegularIframe(url) {
            if (!bodyElement || bodyElement.classList.contains('panic-active') || !contentIframe || !iframeContainer || !searchContainer) return;
            let finalUrl = url.trim();
            if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) finalUrl = 'https://' + finalUrl;
            console.log("Loading regular URL:", finalUrl);
            try {
                contentIframe.src = finalUrl;
                iframeContainer.classList.add('visible');
                searchContainer.style.opacity = '0'; searchContainer.style.visibility = 'hidden'; searchContainer.style.pointerEvents = 'none';
            } catch (e) {
                console.error("Error setting iframe src:", e); alert("Could not load the URL.");
                iframeContainer.classList.remove('visible'); searchContainer.style.opacity = '1'; searchContainer.style.visibility = 'visible'; searchContainer.style.pointerEvents = 'auto';
            }
        }

        function closeRegularIframe() {
             if (!bodyElement || bodyElement.classList.contains('panic-active') || !iframeContainer || !contentIframe || !searchContainer) return;
             iframeContainer.classList.remove('visible');
             contentIframe.src = 'about:blank';
             searchContainer.style.opacity = '1'; searchContainer.style.visibility = 'visible'; searchContainer.style.pointerEvents = 'auto';
        }

        function performSearch() {
            if (!urlInput || !searchBox) return;
            const url = urlInput.value.trim();
            if (url) { showRegularIframe(url); }
            else {
                console.log("User entered no URL.");
                if (!document.getElementById('shake-animation-style')) addShakeAnimation();
                searchBox.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => { if(searchBox) searchBox.style.animation = ''; }, 500);
            }
        }

        function addShakeAnimation() {
             if (document.getElementById('shake-animation-style')) return;
             const styleSheet = document.createElement("style"); styleSheet.id = "shake-animation-style"; styleSheet.type = "text/css";
             styleSheet.innerText = `@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }`;
             document.head.appendChild(styleSheet);
        }

        function initializeApp() {
            getElements(); // Get elements first

            // Apply saved theme *before* checking panic mode
            let savedTheme = 'light'; // Default
            try {
                 savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light';
            } catch (e) { console.error("LocalStorage unavailable for reading theme.", e); }
            applyTheme(savedTheme); // Apply theme and update selector

            // Check initial panic state
            try {
                if (localStorage.getItem(PANIC_STORAGE_KEY) === 'true') {
                    if (bodyElement && contentIframe) enterPanicMode();
                    else document.addEventListener('DOMContentLoaded', enterPanicMode); // Defer if needed
                }
            } catch (e) { console.error("LocalStorage unavailable for initial panic check.", e); }

            // Setup listeners
            if (!bodyElement || !bodyElement.classList.contains('panic-active')) {
                 if (submitSearchButton) submitSearchButton.addEventListener('click', performSearch);
                 if (urlInput) urlInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); performSearch(); } });
                 if (closeButton) closeButton.addEventListener('click', closeRegularIframe);
             }
            // Theme selector listener - always needed unless maybe in panic mode? Let's keep it active.
            if (themeSelector) {
                 themeSelector.addEventListener('change', (event) => {
                     const newTheme = event.target.value;
                     applyTheme(newTheme);
                     saveTheme(newTheme);
                 });
             }

            // Global key listener
            window.addEventListener('keydown', handleGlobalKeys);

            // Add shake animation CSS
            addShakeAnimation();
        }

         function handleGlobalKeys(event) {
             if (event.key === '`') { event.preventDefault(); enterPanicMode(); }
             else if (event.ctrlKey && event.altKey && (event.key === 'x' || event.key === 'X')) {
                  event.preventDefault();
                  if (bodyElement && bodyElement.classList.contains('panic-active')) {
                     exitPanicMode();
                      // Re-attach normal mode listeners
                      if (submitSearchButton) submitSearchButton.addEventListener('click', performSearch);
                      if (urlInput) urlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
                      if (closeButton) closeButton.addEventListener('click', closeRegularIframe);
                  } else { console.log("Ctrl+Alt+X pressed, but not in panic mode."); }
             }
         }

        // --- Execution Start ---
        checkForUpdates().then(() => {
             if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
             } else {
                initializeApp();
             }
         }).catch(error => {
             console.error("Error during update check process:", error);
              if (document.readyState === 'loading') {
                 document.addEventListener('DOMContentLoaded', initializeApp);
              } else { initializeApp(); }
         });

    </script>

</body>
</html>
