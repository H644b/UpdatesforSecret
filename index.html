<!DOCTYPE html>
<html lang="en" data-theme="light"> <!-- Default theme attribute -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Required Head Content -->
    <title id="page-title">Kami</title> <!-- Added ID -->
    <link id="favicon-link" rel="icon" href="https://web.kamihq.com/web/images/icon19.png" type="image/png"> <!-- Added ID -->
    <!-- End Required Head Content -->

    <style>
        /* --- CSS Variables (Themes) --- */
        :root {
            /* Default: Light Theme */
            --bg-color: #f0f2f5;
            --text-color: #24292e;
            --secondary-text-color: #586069;
            --muted-text-color: #6a737d;
            --input-bg: #ffffff;
            --input-border: #d1d5da;
            --placeholder-color: #aaa;
            --primary-btn-bg: #007bff;
            --primary-btn-text: #ffffff;
            --primary-btn-hover-bg: #0056b3;
            --primary-btn-active-bg: #004085;
            --secondary-btn-bg: rgba(40, 40, 40, 0.8);
            --secondary-btn-text: #ffffff;
            --secondary-btn-hover-bg: rgba(0, 0, 0, 1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --iframe-bg: #ffffff;
            --selector-bg: #ffffff;
            --selector-border: #d1d5da;
            --selector-text: #24292e;
            --link-color: #0366d6;
            --overlay-bg: rgba(0, 0, 0, 0.6);
            --panel-bg: #ffffff;
            --panel-shadow: rgba(0, 0, 0, 0.2);
            --icon-button-bg: transparent;
            --icon-button-hover-bg: rgba(0, 0, 0, 0.05);
            --icon-button-text: #586069;
        }

        html[data-theme="dark"] {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --secondary-text-color: #cccccc;
            --muted-text-color: #8b949e;
            --input-bg: #3c3c3c;
            --input-border: #555555;
            --placeholder-color: #888888;
            --primary-btn-bg: #0e639c;
            --primary-btn-text: #ffffff;
            --primary-btn-hover-bg: #1177bb;
            --primary-btn-active-bg: #158bcd;
            --secondary-btn-bg: rgba(200, 200, 200, 0.7);
            --secondary-btn-text: #1e1e1e;
            --secondary-btn-hover-bg: rgba(230, 230, 230, 0.9);
            --shadow-color: rgba(255, 255, 255, 0.05);
            --iframe-bg: #252526;
            --selector-bg: #3c3c3c;
            --selector-border: #555555;
            --selector-text: #d4d4d4;
            --link-color: #4e94ce;
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --panel-bg: #2d2d2d;
            --panel-shadow: rgba(0, 0, 0, 0.5);
            --icon-button-bg: transparent;
            --icon-button-hover-bg: rgba(255, 255, 255, 0.1);
             --icon-button-text: #cccccc;
        }

        /* --- Other theme definitions remain the same, ensure they define --overlay-bg, --panel-bg, --panel-shadow, --icon-button vars --- */
        html[data-theme="vscode-dark-plus"] { --bg-color: #1e1e1e; --text-color: #d4d4d4; --secondary-text-color: #a0a0a0; --muted-text-color: #8b949e; --input-bg: #3c3c3c; --input-border: #3c3c3c; --placeholder-color: #7f7f7f; --primary-btn-bg: #0e639c; --primary-btn-text: #ffffff; --primary-btn-hover-bg: #1177bb; --primary-btn-active-bg: #158bcd; --secondary-btn-bg: rgba(180, 180, 180, 0.7); --secondary-btn-text: #1e1e1e; --secondary-btn-hover-bg: rgba(210, 210, 210, 0.9); --shadow-color: rgba(0, 0, 0, 0.3); --iframe-bg: #1e1e1e; --selector-bg: #3c3c3c; --selector-border: #3c3c3c; --selector-text: #d4d4d4; --link-color: #4e94ce; --overlay-bg: rgba(0, 0, 0, 0.7); --panel-bg: #252526; --panel-shadow: rgba(0, 0, 0, 0.5); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(255, 255, 255, 0.1); --icon-button-text: #a0a0a0; }
        html[data-theme="monokai"] { --bg-color: #272822; --text-color: #f8f8f2; --secondary-text-color: #a9a9a9; --muted-text-color: #75715e; --input-bg: #3e3d32; --input-border: #5b5a4e; --placeholder-color: #9e9e9e; --primary-btn-bg: #ae81ff; --primary-btn-text: #272822; --primary-btn-hover-bg: #be95ff; --primary-btn-active-bg: #cfadff; --secondary-btn-bg: rgba(200, 200, 200, 0.7); --secondary-btn-text: #272822; --secondary-btn-hover-bg: rgba(230, 230, 230, 0.9); --shadow-color: rgba(0, 0, 0, 0.3); --iframe-bg: #272822; --selector-bg: #3e3d32; --selector-border: #5b5a4e; --selector-text: #f8f8f2; --link-color: #66d9ef; --overlay-bg: rgba(0, 0, 0, 0.7); --panel-bg: #272822; --panel-shadow: rgba(0, 0, 0, 0.5); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(255, 255, 255, 0.1); --icon-button-text: #a9a9a9; }
        html[data-theme="solarized-light"] { --bg-color: #fdf6e3; --text-color: #657b83; --secondary-text-color: #93a1a1; --muted-text-color: #93a1a1; --input-bg: #eee8d5; --input-border: #93a1a1; --placeholder-color: #93a1a1; --primary-btn-bg: #268bd2; --primary-btn-text: #fdf6e3; --primary-btn-hover-bg: #1a6a9e; --primary-btn-active-bg: #0f4c75; --secondary-btn-bg: rgba(88, 110, 117, 0.8); --secondary-btn-text: #fdf6e3; --secondary-btn-hover-bg: rgba(40, 50, 55, 1); --shadow-color: rgba(0, 0, 0, 0.08); --iframe-bg: #fdf6e3; --selector-bg: #eee8d5; --selector-border: #93a1a1; --selector-text: #657b83; --link-color: #2aa198; --overlay-bg: rgba(0, 0, 0, 0.5); --panel-bg: #fdf6e3; --panel-shadow: rgba(0, 0, 0, 0.2); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(0, 0, 0, 0.05); --icon-button-text: #657b83; }
        html[data-theme="solarized-dark"] { --bg-color: #002b36; --text-color: #839496; --secondary-text-color: #586e75; --muted-text-color: #586e75; --input-bg: #073642; --input-border: #586e75; --placeholder-color: #586e75; --primary-btn-bg: #268bd2; --primary-btn-text: #fdf6e3; --primary-btn-hover-bg: #1f7bbd; --primary-btn-active-bg: #1a6a9e; --secondary-btn-bg: rgba(147, 161, 161, 0.7); --secondary-btn-text: #002b36; --secondary-btn-hover-bg: rgba(180, 190, 190, 0.9); --shadow-color: rgba(255, 255, 255, 0.05); --iframe-bg: #002b36; --selector-bg: #073642; --selector-border: #586e75; --selector-text: #839496; --link-color: #2aa198; --overlay-bg: rgba(0, 0, 0, 0.7); --panel-bg: #073642; --panel-shadow: rgba(0, 0, 0, 0.4); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(255, 255, 255, 0.1); --icon-button-text: #839496; }


        /* --- Base Styles --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease; position: relative; min-height: 100%; }
        a { color: var(--link-color); }

        /* --- Search Area --- */
        #search-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s; opacity: 1; visibility: visible; text-align: center; }
        #greeting { font-size: 1.4em; font-weight: 500; margin-bottom: 25px; color: var(--text-color); max-width: 600px; width: 100%; }
        #search-box { display: flex; width: 100%; max-width: 600px; background-color: var(--input-bg); border: 1px solid var(--input-border); border-radius: 25px; box-shadow: 0 5px 15px var(--shadow-color); overflow: hidden; margin-bottom: 15px; /* Reduced margin */ transition: background-color 0.3s ease, border-color 0.3s ease; }
        #url-input { flex-grow: 1; padding: 15px 20px; font-size: 1em; border: none; outline: none; background-color: transparent; color: var(--text-color); }
        #url-input::placeholder { color: var(--placeholder-color); opacity: 1; }
        #submit-search-button { padding: 0 25px; font-size: 1em; font-weight: 500; color: var(--primary-btn-text); background-color: var(--primary-btn-bg); border: none; cursor: pointer; transition: background-color 0.2s ease; white-space: nowrap; line-height: 50px; height: 50px; }
        #submit-search-button:hover { background-color: var(--primary-btn-hover-bg); }
        #submit-search-button:active { background-color: var(--primary-btn-active-bg); }

        /* --- Controls Area (Theme + Settings) --- */
        #controls-container {
            display: flex;
            align-items: center;
            gap: 15px; /* Space between theme and settings */
            margin-top: 10px;
        }
        #theme-controls {} /* Container for label + select */
        #theme-selector-label { margin-right: 8px; font-size: 0.9em; color: var(--secondary-text-color); vertical-align: middle; }
        #theme-selector { padding: 8px 12px; font-size: 0.9em; border-radius: 6px; border: 1px solid var(--selector-border); background-color: var(--selector-bg); color: var(--selector-text); cursor: pointer; outline: none; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-repeat: no-repeat; background-position: right 10px center; background-size: 10px auto; padding-right: 30px; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; vertical-align: middle; }
        #theme-selector:hover { border-color: var(--primary-btn-bg); }
        /* SVG arrow updated via JS */
        #settings-button {
            background: var(--icon-button-bg);
            border: none;
            color: var(--icon-button-text);
            font-size: 1.4em; /* Adjust size */
            padding: 5px 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            line-height: 1; /* Prevent extra space */
            vertical-align: middle;
        }
        #settings-button:hover { background-color: var(--icon-button-hover-bg); }

        /* --- Settings Overlay & Panel --- */
        #settings-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1100; /* Above iframe close button */
            visibility: hidden; opacity: 0;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        #settings-overlay.visible {
            visibility: visible; opacity: 1;
            transition: opacity 0.3s ease;
        }
        #settings-panel {
            background-color: var(--panel-bg);
            padding: 25px 30px;
            border-radius: 8px;
            box-shadow: 0 5px 20px var(--panel-shadow);
            width: 90%;
            max-width: 450px;
            position: relative;
            color: var(--text-color);
        }
        #settings-panel h2 {
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-color); /* Ensure heading uses theme text color */
        }
        .settings-field { margin-bottom: 15px; }
        .settings-field label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            font-weight: 500;
            color: var(--secondary-text-color);
        }
        .settings-field input[type="text"],
        .settings-field input[type="url"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 1em;
            outline: none;
        }
        .settings-field input[type="text"]:focus,
        .settings-field input[type="url"]:focus {
             border-color: var(--primary-btn-bg);
             box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); /* Use primary color with alpha */
        }
        #settings-buttons {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            margin-top: 25px;
            gap: 10px;
        }
        #save-settings-button {
            padding: 10px 20px;
            font-size: 0.95em;
            font-weight: 500;
            color: var(--primary-btn-text);
            background-color: var(--primary-btn-bg);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
         #save-settings-button:hover { background-color: var(--primary-btn-hover-bg); }

         #close-settings-button {
             position: absolute;
             top: 10px;
             right: 10px;
             background: transparent;
             border: none;
             font-size: 1.6em;
             color: var(--secondary-text-color);
             cursor: pointer;
             padding: 5px;
             line-height: 1;
             transition: color 0.2s ease;
         }
         #close-settings-button:hover { color: var(--text-color); }


        /* --- Iframe & Controls --- */
        #iframe-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; visibility: hidden; opacity: 0; transition: opacity 0.4s ease-in-out, visibility 0s linear 0.4s; z-index: 1000; background-color: var(--iframe-bg); }
        #iframe-container.visible { visibility: visible; opacity: 1; transition: opacity 0.4s ease-in-out; }
        #content-iframe { width: 100%; height: 100%; border: none; background-color: var(--iframe-bg); }
        #close-button { position: fixed; top: 15px; right: 15px; width: 35px; height: 35px; background-color: var(--secondary-btn-bg); color: var(--secondary-btn-text); border: none; border-radius: 50%; font-size: 20px; font-weight: bold; line-height: 35px; text-align: center; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease, opacity 0.3s ease, visibility 0s linear 0.3s; z-index: 1001; visibility: hidden; opacity: 0; }
        #iframe-container.visible #close-button { visibility: visible; opacity: 1; transition: opacity 0.3s ease-in-out 0.2s, visibility 0s linear 0s, background-color 0.2s ease, color 0.2s ease; }
        #close-button:hover { background-color: var(--secondary-btn-hover-bg); }
        #close-button:active { transform: scale(0.95); }

        /* --- Disclaimer --- */
        #disclaimer { position: fixed; bottom: 10px; left: 0; width: 100%; text-align: center; font-size: 0.75em; color: var(--muted-text-color); padding: 0 15px; z-index: 5; visibility: visible; opacity: 1; transition: opacity 0.5s ease, visibility 0s linear 0.5s; }
        #disclaimer.hidden { opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0s linear 0.5s; }

        /* --- Panic Mode Styles --- */
        body.panic-active #search-container { opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.1s ease, visibility 0s linear 0.1s; }
        body.panic-active #iframe-container { visibility: visible; opacity: 1; transition: none !important; }
        body.panic-active #close-button { display: none !important; }
        body.panic-active #disclaimer { display: none !important; }
        body.panic-active #settings-overlay { display: none !important; } /* Hide settings in panic */

    </style>
</head>
<body>
    <!-- DOC_CONTENT_START -->

    <div id="search-container">
        <h1 id="greeting">Hello, what website do you want to unblock?</h1>
        <div id="search-box">
            <input type="text" id="url-input" placeholder="SIGMASIGMA Enter URL (e.g., https://wikipedia.org)">
            <button id="submit-search-button">Search</button>
        </div>
        <div id="controls-container">
             <div id="theme-controls">
                 <label id="theme-selector-label" for="theme-selector">Theme:</label>
                 <select id="theme-selector">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="vscode-dark-plus">VSCode Dark+</option>
                    <option value="monokai">Monokai</option>
                    <option value="solarized-light">Solarized Light</option>
                    <option value="solarized-dark">Solarized Dark</option>
                </select>
            </div>
            <button id="settings-button" title="Settings">⚙️</button> <!-- Settings Icon -->
        </div>
    </div>

    <div id="iframe-container">
        <button id="close-button" title="Close">×</button>
        <iframe id="content-iframe" src="about:blank" frameborder="0" allowfullscreen></iframe>
    </div>

    <p id="disclaimer">
        This html file auto updates when connected to the internet. Only meant to be used by premium purchasers. Upon reloading this specific link shall disappear.
    </p>

    <!-- Settings Overlay -->
    <div id="settings-overlay">
        <div id="settings-panel">
            <button id="close-settings-button" title="Close Settings">×</button>
            <h2>Settings</h2>
            <div class="settings-field">
                <label for="title-input">Page Title:</label>
                <input type="text" id="title-input">
            </div>
            <div class="settings-field">
                <label for="favicon-input">Favicon URL:</label>
                <input type="url" id="favicon-input" placeholder="https://example.com/favicon.ico">
            </div>
            <div id="settings-buttons">
                <button id="save-settings-button">Save Settings</button>
            </div>
        </div>
    </div>

     <!-- DOC_CONTENT_END -->

    <script>
        // --- Constants ---
        const PANIC_URL = "https://web.kamihq.com/web/viewer.html";
        const PANIC_STORAGE_KEY = 'isInPanicMode';
        const THEME_STORAGE_KEY = 'selectedTheme';
        const TITLE_STORAGE_KEY = 'customPageTitle'; // New Key
        const FAVICON_STORAGE_KEY = 'customFaviconUrl'; // New Key
        const UPDATE_URL = "https://raw.githubusercontent.com/H644b/UpdatesforSecret/main/index.html";
        const UPDATED_HTML_KEY = 'pendingUpdateHTML';
        const UPDATE_APPLIED_SESSION_KEY = 'updateAppliedFlag';

        // --- DOM Elements ---
        let searchContainer, greeting, searchBox, urlInput, submitSearchButton, iframeContainer, contentIframe, closeButton, bodyElement, themeSelector, disclaimerElement,
            settingsButton, settingsOverlay, settingsPanel, closeSettingsButton, titleInput, faviconInput, saveSettingsButton, // Settings GUI elements
            pageTitleElement, faviconLinkElement; // Direct references to head elements

        // --- Default Values (Captured Early) ---
        let initialTitle = '';
        let initialFavicon = '';

        function captureInitialValues() {
            const tempTitle = document.getElementById('page-title');
            const tempFavicon = document.getElementById('favicon-link');
            if (tempTitle) initialTitle = tempTitle.textContent;
            if (tempFavicon) initialFavicon = tempFavicon.href;
        }
        captureInitialValues(); // Run immediately

        function getElements() {
            // Get all other elements as before...
            searchContainer = document.getElementById('search-container');
            greeting = document.getElementById('greeting');
            searchBox = document.getElementById('search-box');
            urlInput = document.getElementById('url-input');
            submitSearchButton = document.getElementById('submit-search-button');
            iframeContainer = document.getElementById('iframe-container');
            contentIframe = document.getElementById('content-iframe');
            closeButton = document.getElementById('close-button');
            bodyElement = document.body;
            themeSelector = document.getElementById('theme-selector');
            disclaimerElement = document.getElementById('disclaimer');
            // Get settings elements
            settingsButton = document.getElementById('settings-button');
            settingsOverlay = document.getElementById('settings-overlay');
            settingsPanel = document.getElementById('settings-panel');
            closeSettingsButton = document.getElementById('close-settings-button');
            titleInput = document.getElementById('title-input');
            faviconInput = document.getElementById('favicon-input');
            saveSettingsButton = document.getElementById('save-settings-button');
            // Get head elements
            pageTitleElement = document.getElementById('page-title');
            faviconLinkElement = document.getElementById('favicon-link');
        }


        // --- Update Function (Checks and Stores for NEXT load) ---
        // Remains the same as previous version
        async function checkForUpdates() { /* ... */ }


        // --- Theme Functions ---
        // Remain the same as previous version
        function applyTheme(themeName) { /* ... */ }
        function saveTheme(themeName) { /* ... */ }

        // --- Customization Functions (Title & Favicon) ---
        function applyCustomization(title, faviconUrl) {
            if (!pageTitleElement || !faviconLinkElement) {
                console.warn("Title or Favicon element not found for customization.");
                return;
            }
            // Apply Title: Use provided title or default if empty/null
            pageTitleElement.textContent = title || initialTitle;

            // Apply Favicon: Use provided URL or default if empty/null
            const targetFaviconUrl = faviconUrl || initialFavicon;
            if (faviconLinkElement.href !== targetFaviconUrl) { // Avoid unnecessary change
                 faviconLinkElement.href = targetFaviconUrl;
                 console.log("Applied Favicon:", targetFaviconUrl);
            }
        }

        function loadCustomization() {
            let savedTitle = initialTitle;
            let savedFaviconUrl = initialFavicon;
            try {
                savedTitle = localStorage.getItem(TITLE_STORAGE_KEY) || initialTitle;
                savedFaviconUrl = localStorage.getItem(FAVICON_STORAGE_KEY) || initialFavicon;
            } catch (e) {
                console.error("LocalStorage unavailable for reading customization.", e);
            }

            // Apply to the actual page elements
            applyCustomization(savedTitle, savedFaviconUrl);

            // Populate the settings input fields (if they exist)
            if (titleInput) titleInput.value = savedTitle;
            if (faviconInput) faviconInput.value = savedFaviconUrl;
        }

        function saveCustomization() {
            if (!titleInput || !faviconInput) return;

            const newTitle = titleInput.value.trim(); // Get value from input
            const newFaviconUrl = faviconInput.value.trim(); // Get value from input

            // Apply immediately
            applyCustomization(newTitle, newFaviconUrl);

            // Save to localStorage
            try {
                localStorage.setItem(TITLE_STORAGE_KEY, newTitle);
                localStorage.setItem(FAVICON_STORAGE_KEY, newFaviconUrl);
                console.log("Settings saved.");
            } catch (e) {
                console.error("LocalStorage unavailable. Customization not saved.", e);
                alert("Error saving settings. LocalStorage might be disabled or full.");
            }

            // Close the settings panel
            if (settingsOverlay) settingsOverlay.classList.remove('visible');
        }

        // --- Panic Mode & Core App Functions ---
        // Mostly same, ensure disclaimer logic is correct
        function enterPanicMode() { /* ... hides disclaimer via class ... */ }
        function exitPanicMode() { /* ... removes class, disclaimer reappears ... */ }
        function showRegularIframe(url) { /* ... hides disclaimer ... */ }
        function closeRegularIframe() { /* ... shows disclaimer ... */ }
        function performSearch() { /* ... */ }
        function addShakeAnimation() { /* ... */ }


        // --- Initialization and Update Application ---
        function initializeApp() {
            getElements(); // Get DOM elements

            // Load and apply Title/Favicon customizations FIRST
            loadCustomization();

            // Apply saved theme
            let savedTheme = 'light';
            try { savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light'; }
            catch (e) { console.error("LocalStorage error reading theme.", e); }
            applyTheme(savedTheme);

            // Check for panic mode
            let isPanic = false;
             try { if (localStorage.getItem(PANIC_STORAGE_KEY) === 'true') { isPanic = true; if (bodyElement) enterPanicMode(); else document.addEventListener('DOMContentLoaded', enterPanicMode); } }
             catch (e) { console.error("LocalStorage error checking panic.", e); }

             // Disclaimer visibility
             let updateJustApplied = false;
             try { updateJustApplied = sessionStorage.getItem(UPDATE_APPLIED_SESSION_KEY) === 'true'; } catch(e) {/*ignore*/}
             if (disclaimerElement) { if (isPanic || updateJustApplied) disclaimerElement.classList.add('hidden'); else disclaimerElement.classList.remove('hidden'); }

            // Setup listeners
            if (!isPanic) {
                 if (submitSearchButton) submitSearchButton.addEventListener('click', performSearch);
                 if (urlInput) urlInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') { event.preventDefault(); performSearch(); } });
                 if (closeButton) closeButton.addEventListener('click', closeRegularIframe);
             } else {
                if(searchContainer) { searchContainer.style.opacity = '0'; searchContainer.style.visibility = 'hidden'; searchContainer.style.pointerEvents = 'none'; }
            }
             // Theme selector listener
             if (themeSelector) { themeSelector.addEventListener('change', (event) => { applyTheme(event.target.value); saveTheme(event.target.value); }); }
            // Settings GUI Listeners
            if (settingsButton) settingsButton.addEventListener('click', () => {
                loadCustomization(); // Ensure inputs have current values before showing
                if(settingsOverlay) settingsOverlay.classList.add('visible');
            });
            if (closeSettingsButton) closeSettingsButton.addEventListener('click', () => { if(settingsOverlay) settingsOverlay.classList.remove('visible'); });
            if (saveSettingsButton) saveSettingsButton.addEventListener('click', saveCustomization);
            // Optional: Close overlay on background click
            if (settingsOverlay) settingsOverlay.addEventListener('click', (event) => { if (event.target === settingsOverlay) settingsOverlay.classList.remove('visible'); });


            // Always setup global key listener
            window.addEventListener('keydown', handleGlobalKeys);

            // Add shake animation CSS
            addShakeAnimation();

            // --- Trigger background update check *after* initialization ---
            setTimeout(checkForUpdates, 1500); // Slightly longer delay maybe
        }

         function handleGlobalKeys(event) {
             // Prevent settings interaction if overlay is open? Maybe not needed.
            // Panic/Exit logic remains the same
             if (event.key === '`') { event.preventDefault(); enterPanicMode(); }
             else if (event.ctrlKey && event.altKey && (event.key === 'x' || event.key === 'X')) {
                 /* ... exit panic logic ... */
             }
         }

        // --- Execution Start ---
        // Update application logic (check storage, reload if needed) remains the same
        // ... (Code from previous version checking UPDATED_HTML_KEY and UPDATE_APPLIED_SESSION_KEY) ...

        // --- Final Initialization Call ---
        if (pendingUpdateHTML) { /* ... reload logic ... */ }
        else {
             // Proceed with normal initialization
             if (document.readyState === 'loading') {
                 document.addEventListener('DOMContentLoaded', initializeApp);
             } else {
                 initializeApp();
             }
         }

        // --- Paste the Update Check/Reload Logic Here (from previous answer) ---
        // 1. Check if an update was just applied via reload
        let updateApplied = false;
        try {
            if (sessionStorage.getItem(UPDATE_APPLIED_SESSION_KEY) === 'true') {
                console.log("Update reload detected. Cleaning up storage.");
                updateApplied = true;
                sessionStorage.removeItem(UPDATE_APPLIED_SESSION_KEY);
                localStorage.removeItem(UPDATED_HTML_KEY); // Clean the applied update
            }
        } catch (e) { console.error("Session/LocalStorage error during update flag check", e); }

        // 2. Check if a *pending* update exists in storage (and update wasn't just applied)
        let pendingUpdateHTML = null;
        if (!updateApplied) {
            try {
                pendingUpdateHTML = localStorage.getItem(UPDATED_HTML_KEY);
            } catch (e) { console.error("LocalStorage error checking for pending update", e); }
        }

        if (pendingUpdateHTML) {
            console.log("Pending update found in storage. Triggering reload to apply...");
            try {
                sessionStorage.setItem(UPDATE_APPLIED_SESSION_KEY, 'true');
                window.location.reload(true);
            } catch (e) {
                console.error("Failed to set sessionStorage flag or reload for update.", e);
                initializeApp(); // Proceed if reload fails
            }
        } else {
            // 3. No pending update OR update was just applied and cleaned up
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                initializeApp();
            }
        }
        // --- End of Pasted Update Check/Reload Logic ---

        // --- Re-paste checkForUpdates and other functions if they were removed ---
        async function checkForUpdates() { /* ... same as before ... */ }
        function applyTheme(themeName) { /* ... same as before ... */ }
        function saveTheme(themeName) { /* ... same as before ... */ }
        function enterPanicMode() { /* ... same as before ... */ }
        function exitPanicMode() { /* ... same as before ... */ }
        function showRegularIframe(url) { /* ... same as before ... */ }
        function closeRegularIframe() { /* ... same as before ... */ }
        function performSearch() { /* ... same as before ... */ }
        function addShakeAnimation() { /* ... same as before ... */ }

    </script>

</body>
</html>
