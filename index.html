<!DOCTYPE html>
<html lang="en" data-theme="light"> <!-- Default theme attribute -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Required Head Content -->
    <title id="page-title">Kami</title> <!-- Added ID -->
    <link id="favicon-link" rel="icon" href="https://web.kamihq.com/web/images/icon19.png" type="image/png"> <!-- Added ID -->
    <!-- End Required Head Content -->

    <style>
        /* --- CSS Variables (Themes) --- */
        :root { /* Light Theme Defaults */ --bg-color: #f0f2f5; --text-color: #24292e; --secondary-text-color: #586069; --muted-text-color: #6a737d; --input-bg: #ffffff; --input-border: #d1d5da; --placeholder-color: #aaa; --primary-btn-bg: #007bff; --primary-btn-text: #ffffff; --primary-btn-hover-bg: #0056b3; --primary-btn-active-bg: #004085; --secondary-btn-bg: rgba(40, 40, 40, 0.8); --secondary-btn-text: #ffffff; --secondary-btn-hover-bg: rgba(0, 0, 0, 1); --shadow-color: rgba(0, 0, 0, 0.1); --iframe-bg: #ffffff; --selector-bg: #ffffff; --selector-border: #d1d5da; --selector-text: #24292e; --link-color: #0366d6; --overlay-bg: rgba(0, 0, 0, 0.6); --panel-bg: #ffffff; --panel-shadow: rgba(0, 0, 0, 0.2); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(0, 0, 0, 0.05); --icon-button-text: #586069; --success-color: #28a745; --warning-color: #ffc107; --error-color: #dc3545; }
        html[data-theme="dark"] { /* Dark Theme Overrides */ --bg-color: #1e1e1e; --text-color: #d4d4d4; --secondary-text-color: #cccccc; --muted-text-color: #8b949e; --input-bg: #3c3c3c; --input-border: #555555; --placeholder-color: #888888; --primary-btn-bg: #0e639c; --primary-btn-text: #ffffff; --primary-btn-hover-bg: #1177bb; --primary-btn-active-bg: #158bcd; --secondary-btn-bg: rgba(200, 200, 200, 0.7); --secondary-btn-text: #1e1e1e; --secondary-btn-hover-bg: rgba(230, 230, 230, 0.9); --shadow-color: rgba(255, 255, 255, 0.05); --iframe-bg: #252526; --selector-bg: #3c3c3c; --selector-border: #555555; --selector-text: #d4d4d4; --link-color: #4e94ce; --overlay-bg: rgba(0, 0, 0, 0.7); --panel-bg: #2d2d2d; --panel-shadow: rgba(0, 0, 0, 0.5); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(255, 255, 255, 0.1); --icon-button-text: #cccccc; --success-color: #34c759; --warning-color: #ffcc00; --error-color: #ff3b30; }
        /* ... (Other theme definitions - vscode, monokai, solarized) ... */
        html[data-theme="vscode-dark-plus"] { --bg-color: #1e1e1e; --text-color: #d4d4d4; --secondary-text-color: #a0a0a0; --muted-text-color: #8b949e; --input-bg: #3c3c3c; --input-border: #3c3c3c; --placeholder-color: #7f7f7f; --primary-btn-bg: #0e639c; --primary-btn-text: #ffffff; --primary-btn-hover-bg: #1177bb; --primary-btn-active-bg: #158bcd; --secondary-btn-bg: rgba(180, 180, 180, 0.7); --secondary-btn-text: #1e1e1e; --secondary-btn-hover-bg: rgba(210, 210, 210, 0.9); --shadow-color: rgba(0, 0, 0, 0.3); --iframe-bg: #1e1e1e; --selector-bg: #3c3c3c; --selector-border: #3c3c3c; --selector-text: #d4d4d4; --link-color: #4e94ce; --overlay-bg: rgba(0, 0, 0, 0.7); --panel-bg: #252526; --panel-shadow: rgba(0, 0, 0, 0.5); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(255, 255, 255, 0.1); --icon-button-text: #a0a0a0; --success-color: #34c759; --warning-color: #ffcc00; --error-color: #ff3b30;}
        html[data-theme="monokai"] { --bg-color: #272822; --text-color: #f8f8f2; --secondary-text-color: #a9a9a9; --muted-text-color: #75715e; --input-bg: #3e3d32; --input-border: #5b5a4e; --placeholder-color: #9e9e9e; --primary-btn-bg: #ae81ff; --primary-btn-text: #272822; --primary-btn-hover-bg: #be95ff; --primary-btn-active-bg: #cfadff; --secondary-btn-bg: rgba(200, 200, 200, 0.7); --secondary-btn-text: #272822; --secondary-btn-hover-bg: rgba(230, 230, 230, 0.9); --shadow-color: rgba(0, 0, 0, 0.3); --iframe-bg: #272822; --selector-bg: #3e3d32; --selector-border: #5b5a4e; --selector-text: #f8f8f2; --link-color: #66d9ef; --overlay-bg: rgba(0, 0, 0, 0.7); --panel-bg: #272822; --panel-shadow: rgba(0, 0, 0, 0.5); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(255, 255, 255, 0.1); --icon-button-text: #a9a9a9; --success-color: #a6e22e; --warning-color: #e6db74; --error-color: #f92672; }
        html[data-theme="solarized-light"] { --bg-color: #fdf6e3; --text-color: #657b83; --secondary-text-color: #93a1a1; --muted-text-color: #93a1a1; --input-bg: #eee8d5; --input-border: #93a1a1; --placeholder-color: #93a1a1; --primary-btn-bg: #268bd2; --primary-btn-text: #fdf6e3; --primary-btn-hover-bg: #1a6a9e; --primary-btn-active-bg: #0f4c75; --secondary-btn-bg: rgba(88, 110, 117, 0.8); --secondary-btn-text: #fdf6e3; --secondary-btn-hover-bg: rgba(40, 50, 55, 1); --shadow-color: rgba(0, 0, 0, 0.08); --iframe-bg: #fdf6e3; --selector-bg: #eee8d5; --selector-border: #93a1a1; --selector-text: #657b83; --link-color: #2aa198; --overlay-bg: rgba(0, 0, 0, 0.5); --panel-bg: #fdf6e3; --panel-shadow: rgba(0, 0, 0, 0.2); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(0, 0, 0, 0.05); --icon-button-text: #657b83; --success-color: #859900; --warning-color: #b58900; --error-color: #dc322f; }
        html[data-theme="solarized-dark"] { --bg-color: #002b36; --text-color: #839496; --secondary-text-color: #586e75; --muted-text-color: #586e75; --input-bg: #073642; --input-border: #586e75; --placeholder-color: #586e75; --primary-btn-bg: #268bd2; --primary-btn-text: #fdf6e3; --primary-btn-hover-bg: #1f7bbd; --primary-btn-active-bg: #1a6a9e; --secondary-btn-bg: rgba(147, 161, 161, 0.7); --secondary-btn-text: #002b36; --secondary-btn-hover-bg: rgba(180, 190, 190, 0.9); --shadow-color: rgba(255, 255, 255, 0.05); --iframe-bg: #002b36; --selector-bg: #073642; --selector-border: #586e75; --selector-text: #839496; --link-color: #2aa198; --overlay-bg: rgba(0, 0, 0, 0.7); --panel-bg: #073642; --panel-shadow: rgba(0, 0, 0, 0.4); --icon-button-bg: transparent; --icon-button-hover-bg: rgba(255, 255, 255, 0.1); --icon-button-text: #839496; --success-color: #859900; --warning-color: #b58900; --error-color: #dc322f; }


        /* --- Base Styles --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease; position: relative; min-height: 100%; }
        a { color: var(--link-color); }

        /* --- Search Area & Controls --- */
        #search-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s; opacity: 1; visibility: visible; text-align: center; }
        #greeting { font-size: 1.4em; font-weight: 500; margin-bottom: 25px; color: var(--text-color); max-width: 600px; width: 100%; }
        #search-box { display: flex; width: 100%; max-width: 600px; background-color: var(--input-bg); border: 1px solid var(--input-border); border-radius: 25px; box-shadow: 0 5px 15px var(--shadow-color); overflow: hidden; margin-bottom: 15px; transition: background-color 0.3s ease, border-color 0.3s ease; }
        #url-input { flex-grow: 1; padding: 15px 20px; font-size: 1em; border: none; outline: none; background-color: transparent; color: var(--text-color); }
        #url-input::placeholder { color: var(--placeholder-color); opacity: 1; }
        #submit-search-button { padding: 0 25px; font-size: 1em; font-weight: 500; color: var(--primary-btn-text); background-color: var(--primary-btn-bg); border: none; cursor: pointer; transition: background-color 0.2s ease; white-space: nowrap; line-height: 50px; height: 50px; }
        #submit-search-button:hover { background-color: var(--primary-btn-hover-bg); }
        #submit-search-button:active { background-color: var(--primary-btn-active-bg); }
        #controls-container { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        #theme-controls {}
        #theme-selector-label { margin-right: 8px; font-size: 0.9em; color: var(--secondary-text-color); vertical-align: middle; }
        #theme-selector { padding: 8px 12px; font-size: 0.9em; border-radius: 6px; border: 1px solid var(--selector-border); background-color: var(--selector-bg); color: var(--selector-text); cursor: pointer; outline: none; -webkit-appearance: none; -moz-appearance: none; appearance: none; background-repeat: no-repeat; background-position: right 10px center; background-size: 10px auto; padding-right: 30px; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; vertical-align: middle; }
        #theme-selector:hover { border-color: var(--primary-btn-bg); }
        #settings-button { background: var(--icon-button-bg); border: none; color: var(--icon-button-text); font-size: 1.4em; padding: 5px 8px; border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; line-height: 1; vertical-align: middle; }
        #settings-button:hover { background-color: var(--icon-button-hover-bg); }

        /* --- Update Controls --- */
        #update-controls { margin-top: 15px; text-align: center; }
        #install-update-button { /* Renamed ID */
            padding: 8px 15px; font-size: 0.9em;
            color: var(--primary-btn-text); background-color: var(--success-color); /* Use success color */
            border: none; border-radius: 5px; cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.3s ease;
            opacity: 0; visibility: hidden; /* Hidden by default */
        }
        #install-update-button.visible { /* Show when update available */
             opacity: 1; visibility: visible;
         }
        #install-update-button:hover { background-color: color-mix(in srgb, var(--success-color) 85%, black); }
        #update-status { font-size: 0.8em; margin-top: 8px; color: var(--secondary-text-color); min-height: 1.2em; }
        #update-status.success { color: var(--success-color); }
        #update-status.warning { color: var(--warning-color); }
        #update-status.error { color: var(--error-color); }

        /* --- Settings Overlay & Panel --- */
        #settings-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--overlay-bg); display: flex; justify-content: center; align-items: center; z-index: 1100; visibility: hidden; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        #settings-overlay.visible { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }
        #settings-panel { background-color: var(--panel-bg); padding: 25px 30px; border-radius: 8px; box-shadow: 0 5px 20px var(--panel-shadow); width: 90%; max-width: 450px; position: relative; color: var(--text-color); }
        #settings-panel h2 { margin-top: 0; margin-bottom: 20px; text-align: center; color: var(--text-color); }
        .settings-field { margin-bottom: 15px; }
        .settings-field label { display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: 500; color: var(--secondary-text-color); }
        .settings-field input[type="text"], .settings-field input[type="url"] { width: 100%; padding: 10px 12px; border: 1px solid var(--input-border); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color); font-size: 1em; outline: none; }
        .settings-field input[type="text"]:focus, .settings-field input[type="url"]:focus { border-color: var(--primary-btn-bg); box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-btn-bg) 25%, transparent); }
        #settings-buttons { display: flex; justify-content: flex-end; margin-top: 25px; gap: 10px; }
        #save-settings-button { padding: 10px 20px; font-size: 0.95em; font-weight: 500; color: var(--primary-btn-text); background-color: var(--primary-btn-bg); border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease; }
        #save-settings-button:hover { background-color: var(--primary-btn-hover-bg); }
        #close-settings-button { position: absolute; top: 10px; right: 10px; background: transparent; border: none; font-size: 1.6em; color: var(--secondary-text-color); cursor: pointer; padding: 5px; line-height: 1; transition: color 0.2s ease; }
        #close-settings-button:hover { color: var(--text-color); }

        /* --- Iframe & Controls --- */
        #iframe-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; visibility: hidden; opacity: 0; transition: opacity 0.4s ease-in-out, visibility 0s linear 0.4s; z-index: 1000; background-color: var(--iframe-bg); }
        #iframe-container.visible { visibility: visible; opacity: 1; transition: opacity 0.4s ease-in-out; }
        #content-iframe { width: 100%; height: 100%; border: none; background-color: var(--iframe-bg); }
        #close-button { position: fixed; top: 15px; right: 15px; width: 35px; height: 35px; background-color: var(--secondary-btn-bg); color: var(--secondary-btn-text); border: none; border-radius: 50%; font-size: 20px; font-weight: bold; line-height: 35px; text-align: center; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease, opacity 0.3s ease, visibility 0s linear 0.3s; z-index: 1001; visibility: hidden; opacity: 0; }
        #iframe-container.visible #close-button { visibility: visible; opacity: 1; transition: opacity 0.3s ease-in-out 0.2s, visibility 0s linear 0s, background-color 0.2s ease, color 0.2s ease; }
        #close-button:hover { background-color: var(--secondary-btn-hover-bg); }
        #close-button:active { transform: scale(0.95); }

        /* --- Disclaimer --- */
        #disclaimer { position: fixed; bottom: 10px; left: 0; width: 100%; text-align: center; font-size: 0.75em; color: var(--muted-text-color); padding: 0 15px; z-index: 5; visibility: visible; opacity: 1; transition: opacity 0.5s ease, visibility 0s linear 0.5s; }
        #disclaimer.hidden { opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0s linear 0.5s; }

        /* --- Panic Mode Styles --- */
        body.panic-active #search-container,
        body.panic-active #update-controls { /* Hide update controls too */
            opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 0.1s ease, visibility 0s linear 0.1s;
        }
        body.panic-active #iframe-container { visibility: visible; opacity: 1; transition: none !important; }
        body.panic-active #close-button { display: none !important; }
        body.panic-active #disclaimer { display: none !important; }
        body.panic-active #settings-overlay { display: none !important; }

         /* Shake Animation */
         @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
         #shake-animation-style { display: none; }

    </style>
</head>
<body>
    <!-- DOC_CONTENT_START -->

    <div id="search-container">
        <h1 id="greeting">Hello, what website do you want to unblock?</h1>
        <div id="search-box">
            <input type="text" id="url-input" placeholder="Enter URL (e.g., https://wikipedia.org)">
            <button id="submit-search-button">Search</button>
        </div>
        <div id="controls-container">
             <div id="theme-controls">
                 <label id="theme-selector-label" for="theme-selector">Theme:</label>
                 <select id="theme-selector"><!-- Options added by JS --></select>
            </div>
            <button id="settings-button" title="Settings">⚙️</button>
        </div>
         <!-- Update Controls Added -->
         <div id="update-controls">
             <button id="install-update-button">Install Update</button> <!-- Renamed ID -->
             <p id="update-status"></p>
         </div>
    </div>

    <div id="iframe-container">
        <button id="close-button" title="Close">×</button>
        <iframe id="content-iframe" src="about:blank" frameborder="0" allowfullscreen></iframe>
    </div>

    <p id="disclaimer"><!-- Text added by JS --></p>

    <!-- Settings Overlay -->
    <div id="settings-overlay">
        <div id="settings-panel">
            <button id="close-settings-button" title="Close Settings">×</button>
            <h2>Settings</h2>
            <div class="settings-field">
                <label for="title-input">Page Title:</label>
                <input type="text" id="title-input">
            </div>
            <div class="settings-field">
                <label for="favicon-input">Favicon URL:</label>
                <input type="url" id="favicon-input" placeholder="https://example.com/favicon.ico">
            </div>
            <div id="settings-buttons">
                <button id="save-settings-button">Save Settings</button>
            </div>
        </div>
    </div>

     <!-- DOC_CONTENT_END -->

    <script>
        // --- Constants ---
        const PANIC_URL = "https://web.kamihq.com/web/viewer.html";
        const PANIC_STORAGE_KEY = 'isInPanicMode';
        const THEME_STORAGE_KEY = 'selectedTheme';
        const TITLE_STORAGE_KEY = 'customPageTitle';
        const FAVICON_STORAGE_KEY = 'customFaviconUrl';
        const UPDATE_URL = "https://raw.githubusercontent.com/H644b/UpdatesforSecret/main/index.html";
        // REMOVED IndexedDB constants

        // --- DOM Elements ---
        let searchContainer, greeting, searchBox, urlInput, submitSearchButton, iframeContainer, contentIframe, closeButton, bodyElement, themeSelector, disclaimerElement,
            settingsButton, settingsOverlay, settingsPanel, closeSettingsButton, titleInput, faviconInput, saveSettingsButton,
            pageTitleElement, faviconLinkElement,
            installUpdateButton, updateStatusElement, updateControls; // Renamed/Added Update GUI elements

        // --- Default Values ---
        let initialTitle = '';
        let initialFavicon = '';
        captureInitialValues();

        // --- State ---
        // REMOVED db = null;
        // REMOVED selfFileHandle = null;
        let pendingUpdateContent = null; // Holds fetched HTML if update available
        let isCheckingUpdates = false;

        // --- Helper: Capture Initial Title/Favicon ---
        function captureInitialValues() {
            const tempTitle = document.getElementById('page-title');
            const tempFavicon = document.getElementById('favicon-link');
            if (tempTitle) initialTitle = tempTitle.textContent;
            if (tempFavicon) initialFavicon = tempFavicon.href;
        }

        // --- Helper: Get DOM Elements ---
        function getElements() {
            searchContainer = document.getElementById('search-container');
            greeting = document.getElementById('greeting');
            searchBox = document.getElementById('search-box');
            urlInput = document.getElementById('url-input');
            submitSearchButton = document.getElementById('submit-search-button');
            iframeContainer = document.getElementById('iframe-container');
            contentIframe = document.getElementById('content-iframe');
            closeButton = document.getElementById('close-button');
            bodyElement = document.body;
            themeSelector = document.getElementById('theme-selector');
            disclaimerElement = document.getElementById('disclaimer');
            settingsButton = document.getElementById('settings-button');
            settingsOverlay = document.getElementById('settings-overlay');
            settingsPanel = document.getElementById('settings-panel');
            closeSettingsButton = document.getElementById('close-settings-button');
            titleInput = document.getElementById('title-input');
            faviconInput = document.getElementById('favicon-input');
            saveSettingsButton = document.getElementById('save-settings-button');
            pageTitleElement = document.getElementById('page-title');
            faviconLinkElement = document.getElementById('favicon-link');
            installUpdateButton = document.getElementById('install-update-button'); // Renamed ID
            updateStatusElement = document.getElementById('update-status');
            updateControls = document.getElementById('update-controls'); // Container for visibility

             // Populate static parts if needed
             if (themeSelector && themeSelector.options.length === 0) {
                 const themes = { "light": "Light", "dark": "Dark", "vscode-dark-plus": "VSCode Dark+", "monokai": "Monokai", "solarized-light": "Solarized Light", "solarized-dark": "Solarized Dark" };
                 for (const [value, text] of Object.entries(themes)) { const opt = document.createElement('option'); opt.value = value; opt.textContent = text; themeSelector.appendChild(opt); }
             }
             if (disclaimerElement && !disclaimerElement.textContent) { disclaimerElement.textContent = "This html file auto updates when connected to the internet. Only meant to be used by premium purchasers. Upon reloading this specific link shall disappear."; }
        }

        // --- REMOVED IndexedDB Functions ---

        // --- File System Access API Functions ---
        async function verifyPermission(fileHandle, request = false) {
             // Simplified: Request permission right when needed
             if (!fileHandle || !fileHandle.requestPermission) return false; // Check API support
             try {
                 const options = { mode: 'readwrite' };
                 // Check current status first silently (optional, but good practice)
                 if ((await fileHandle.queryPermission(options)) === 'granted') return true;
                 // If requesting, ask the user
                 if (request && (await fileHandle.requestPermission(options)) === 'granted') return true;
             } catch (err) { console.error("Error verifying/requesting permission:", err); }
             return false;
        }

         async function writeFile(fileHandle, content) {
             // Assumes permission was just granted before calling this
             if (!fileHandle) throw new Error("No file handle provided to write.");
             try {
                 const writable = await fileHandle.createWritable();
                 await writable.write(content);
                 await writable.close();
                 console.log("File written successfully.");
                 return true;
             } catch (err) {
                 console.error("Error writing file:", err);
                 setUpdateStatus(`Error writing file: ${err.message}`, "error");
                 return false;
             }
         }

        // --- Update Function (Checks and Notifies) ---
        async function checkForUpdatesAndNotify() {
             if (isCheckingUpdates) { console.log("Update check already in progress."); return; }
             // No handle check here anymore

             isCheckingUpdates = true;
             setUpdateStatus("Checking for updates...", "");
             console.log("Checking for updates...");
             pendingUpdateContent = null; // Clear previous pending update
             if(installUpdateButton) installUpdateButton.classList.remove('visible'); // Hide button initially

             try {
                 const response = await fetch(UPDATE_URL, { cache: 'no-store', mode: 'cors' });
                 if (!response.ok) throw new Error(`Fetch failed: ${response.status} ${response.statusText}`);
                 const newHtmlText = await response.text();
                 const currentHtmlText = document.documentElement.outerHTML;

                 if (newHtmlText && newHtmlText.trim() !== currentHtmlText.trim()) {
                     console.log("Update found!");
                     setUpdateStatus("Update available!", "success");
                     pendingUpdateContent = newHtmlText; // Store content for install button
                     if (installUpdateButton) installUpdateButton.classList.add('visible'); // Show button

                 } else {
                     console.log("No update needed or content identical.");
                     setUpdateStatus("Already up to date.", "success");
                     setTimeout(() => setUpdateStatus("", ""), 5000); // Clear status after delay
                 }
             } catch (error) {
                 console.error("Update check failed:", error);
                 setUpdateStatus(`Update check failed: ${error.message || 'Network error'}`, "error");
             } finally {
                 isCheckingUpdates = false;
             }
         }

         // --- Install Update Function (Triggered by Button) ---
         async function promptAndInstallUpdate() {
             if (!pendingUpdateContent) {
                 setUpdateStatus("No update content available. Check again?", "warning");
                 if(installUpdateButton) installUpdateButton.classList.remove('visible');
                 return;
             }
             if (!('showOpenFilePicker' in window)) {
                 setUpdateStatus("File System Access API not supported.", "error");
                 return;
             }

             setUpdateStatus("Select the HTML file to update...", "warning");
             let handle;
             try {
                 [handle] = await window.showOpenFilePicker({ types: [{ description: 'HTML Files', accept: { 'text/html': ['.html', '.htm'] } }], multiple: false });

                 // Request permission for this specific handle/interaction
                 const permissionGranted = await verifyPermission(handle, true);

                 if (permissionGranted) {
                     setUpdateStatus("Writing update...", "warning");
                     const writeSuccess = await writeFile(handle, pendingUpdateContent);

                     if (writeSuccess) {
                         setUpdateStatus("Update applied! Reloading...", "success");
                         pendingUpdateContent = null; // Clear temp content
                         if(installUpdateButton) installUpdateButton.classList.remove('visible'); // Hide button
                         setTimeout(() => { window.location.reload(true); }, 1500);
                     } // else: writeFile sets error status

                 } else {
                     setUpdateStatus("Permission denied.", "error");
                 }

             } catch (err) {
                 if (err.name === 'AbortError') { setUpdateStatus("File selection cancelled.", "warning"); }
                 else { console.error("Error requesting/writing file:", err); setUpdateStatus(`Error updating: ${err.message}`, "error"); }
                 // Keep button visible on error/cancel? Maybe.
                 // if(installUpdateButton) installUpdateButton.classList.remove('visible');
             }
         }

         function setUpdateStatus(message, type = "") {
             if (!updateStatusElement) return;
             updateStatusElement.textContent = message;
             updateStatusElement.className = type;
         }

        // --- Theme Functions ---
        function applyTheme(themeName) {
            console.log("Applying theme:", themeName);
            if (!themeName) themeName = 'light';
            document.documentElement.setAttribute('data-theme', themeName);
            if (themeSelector) themeSelector.value = themeName;
            try {
                let arrowColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-text-color').trim() || '#586069';
                if (themeSelector) themeSelector.style.backgroundImage = `url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2210%22%20height%3D%225%22%20viewBox%3D%220%200%2010%205%22%3E%3Cpath%20fill%3D%22${encodeURIComponent(arrowColor)}%22%20d%3D%22M0%200l5%205%205-5z%22%2F%3E%3C%2Fsvg%3E')`;
            } catch (e) { console.warn("Could not update selector arrow color", e); }
        }
        function saveTheme(themeName) {
             try { localStorage.setItem(THEME_STORAGE_KEY, themeName); }
             catch (e) { console.error("LocalStorage unavailable saving theme.", e); }
        }

        // --- Customization Functions (Title & Favicon) ---
        function applyCustomization(title, faviconUrl) {
            if (!pageTitleElement || !faviconLinkElement) { console.warn("Title/Favicon element missing."); return; }
            pageTitleElement.textContent = title || initialTitle;
            const targetFaviconUrl = faviconUrl || initialFavicon;
            if (faviconLinkElement.href !== targetFaviconUrl) { faviconLinkElement.href = targetFaviconUrl; }
        }
        function loadCustomization() {
            let savedTitle = initialTitle; let savedFaviconUrl = initialFavicon;
            try {
                savedTitle = localStorage.getItem(TITLE_STORAGE_KEY) || initialTitle;
                savedFaviconUrl = localStorage.getItem(FAVICON_STORAGE_KEY) || initialFavicon;
            } catch (e) { console.error("LocalStorage unavailable reading customization.", e); }
            applyCustomization(savedTitle, savedFaviconUrl);
            if (titleInput) titleInput.value = savedTitle;
            if (faviconInput) faviconInput.value = savedFaviconUrl;
        }
        function saveCustomization() {
            if (!titleInput || !faviconInput) return;
            const newTitle = titleInput.value.trim();
            const newFaviconUrl = faviconInput.value.trim();
            applyCustomization(newTitle, newFaviconUrl);
            try {
                localStorage.setItem(TITLE_STORAGE_KEY, newTitle);
                localStorage.setItem(FAVICON_STORAGE_KEY, newFaviconUrl);
                console.log("Settings saved.");
            } catch (e) { console.error("LocalStorage unavailable saving customization.", e); alert("Error saving settings."); }
            if (settingsOverlay) settingsOverlay.classList.remove('visible');
        }

        // --- Panic Mode & Core App Functions ---
        function enterPanicMode() {
            if (!contentIframe || !bodyElement || !localStorage || !searchContainer || !iframeContainer || !disclaimerElement) return;
            console.log("Entering Panic Mode");
            contentIframe.src = PANIC_URL;
            bodyElement.classList.add('panic-active');
            try { localStorage.setItem(PANIC_STORAGE_KEY, 'true'); } catch (e) { console.error("LocalStorage unavailable.", e); }
            if(iframeContainer) iframeContainer.classList.add('visible');
        }
        function exitPanicMode() {
             if (!bodyElement || !localStorage || !iframeContainer || !contentIframe || !searchContainer || !disclaimerElement) return;
             console.log("Exiting Panic Mode");
             try { localStorage.removeItem(PANIC_STORAGE_KEY); } catch (e) { console.error("LocalStorage unavailable.", e); }
             bodyElement.classList.remove('panic-active');
             if(iframeContainer) iframeContainer.classList.remove('visible');
             if(contentIframe) contentIframe.src = 'about:blank';
             attachNormalModeListeners(); // Reattach listeners
        }
        function showRegularIframe(url) {
            if (!bodyElement || bodyElement.classList.contains('panic-active') || !contentIframe || !iframeContainer || !searchContainer || !disclaimerElement || !updateControls) return;
            let finalUrl = url.trim();
            if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) finalUrl = 'https://' + finalUrl;
            console.log("Loading regular URL:", finalUrl);
            try {
                contentIframe.src = finalUrl;
                iframeContainer.classList.add('visible');
                searchContainer.style.opacity = '0'; searchContainer.style.visibility = 'hidden'; searchContainer.style.pointerEvents = 'none';
                updateControls.style.opacity = '0'; updateControls.style.visibility = 'hidden'; updateControls.style.pointerEvents = 'none';
                disclaimerElement.classList.add('hidden');
            } catch (e) {
                console.error("Error setting iframe src:", e); alert("Could not load the URL.");
                iframeContainer.classList.remove('visible'); searchContainer.style.opacity = '1'; searchContainer.style.visibility = 'visible'; searchContainer.style.pointerEvents = 'auto';
                updateControls.style.opacity = '1'; updateControls.style.visibility = 'visible'; updateControls.style.pointerEvents = 'auto';
                 disclaimerElement.classList.remove('hidden');
            }
        }
        function closeRegularIframe() {
             if (!bodyElement || bodyElement.classList.contains('panic-active') || !iframeContainer || !contentIframe || !searchContainer || !disclaimerElement || !updateControls) return;
             iframeContainer.classList.remove('visible');
             contentIframe.src = 'about:blank';
             searchContainer.style.opacity = '1'; searchContainer.style.visibility = 'visible'; searchContainer.style.pointerEvents = 'auto';
             updateControls.style.opacity = '1'; updateControls.style.visibility = 'visible'; updateControls.style.pointerEvents = 'auto';
             disclaimerElement.classList.remove('hidden');
        }
        function performSearch() {
            if (!urlInput || !searchBox || !disclaimerElement) return;
            const url = urlInput.value.trim();
            if (url) { showRegularIframe(url); }
            else {
                console.log("User entered no URL.");
                if (!document.getElementById('shake-animation-style')) addShakeAnimation();
                searchBox.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => { if(searchBox) searchBox.style.animation = ''; }, 500);
            }
        }
        function addShakeAnimation() {
             const styleId = 'shake-animation-style'; if (document.getElementById(styleId)) return;
             const styleSheet = document.createElement("style"); styleSheet.id = styleId; styleSheet.type = "text/css";
             styleSheet.innerText = `@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }`;
             document.head.appendChild(styleSheet);
        }


        // --- Initialization ---
        async function initializeApp() {
            getElements(); // Get DOM elements

            // REMOVED IndexedDB/Handle loading

            loadCustomization(); // Load Title/Favicon
            let savedTheme = 'light'; try { savedTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'light'; } catch (e) { console.error("LocalStorage error reading theme.", e); } applyTheme(savedTheme); // Apply theme

            let isPanic = false; // Check panic mode
             try { if (localStorage.getItem(PANIC_STORAGE_KEY) === 'true') { isPanic = true; if (bodyElement) enterPanicMode(); else document.addEventListener('DOMContentLoaded', enterPanicMode); } }
             catch (e) { console.error("LocalStorage error checking panic.", e); }

             if (disclaimerElement) { if (isPanic) disclaimerElement.classList.add('hidden'); else disclaimerElement.classList.remove('hidden'); } // Disclaimer visibility

            attachListeners(isPanic); // Attach all event listeners
            addShakeAnimation(); // Add animation style if needed

            // Initial check for updates after a delay
             if (!isPanic) { // Don't check if starting in panic
                 setTimeout(checkForUpdatesAndNotify, 1500);
             }
        }

        // --- Event Listeners ---
        function attachListeners(isPanic) {
             window.addEventListener('keydown', handleGlobalKeys);
             if (themeSelector) themeSelector.addEventListener('change', (event) => { applyTheme(event.target.value); saveTheme(event.target.value); });
             if (settingsButton) settingsButton.addEventListener('click', () => { loadCustomization(); if(settingsOverlay) settingsOverlay.classList.add('visible'); });
             if (closeSettingsButton) closeSettingsButton.addEventListener('click', () => { if(settingsOverlay) settingsOverlay.classList.remove('visible'); });
             if (saveSettingsButton) saveSettingsButton.addEventListener('click', saveCustomization);
             if (settingsOverlay) settingsOverlay.addEventListener('click', (event) => { if (event.target === settingsOverlay) settingsOverlay.classList.remove('visible'); });
             // Update Button Listener
             if(installUpdateButton) installUpdateButton.addEventListener('click', promptAndInstallUpdate);

            if (!isPanic) { attachNormalModeListeners(); }
            else { // Ensure UI hidden if starting in panic
                 if(searchContainer) { searchContainer.style.opacity = '0'; searchContainer.style.visibility = 'hidden'; searchContainer.style.pointerEvents = 'none'; }
                 if(updateControls) { updateControls.style.opacity = '0'; updateControls.style.visibility = 'hidden'; updateControls.style.pointerEvents = 'none'; }
            }
        }
         function attachNormalModeListeners() {
              if (submitSearchButton) submitSearchButton.onclick = performSearch; // Use onclick to easily override/remove if needed, or manage listeners carefully
              if (urlInput) urlInput.onkeypress = handleUrlInputKeypress;
              if (closeButton) closeButton.onclick = closeRegularIframe;
         }
         function handleUrlInputKeypress(event) { if (event.key === 'Enter' || event.keyCode === 13) { event.preventDefault(); performSearch(); } }
         function handleGlobalKeys(event) {
             if (event.key === '`') { event.preventDefault(); enterPanicMode(); }
             else if (event.ctrlKey && event.altKey && (event.key === 'x' || event.key === 'X')) {
                  event.preventDefault();
                  if (bodyElement && bodyElement.classList.contains('panic-active')) { exitPanicMode(); }
                  else { console.log("Ctrl+Alt+X pressed, but not in panic mode."); }
             }
         }

        // --- Execution Start ---
        // Simpler start now, no update pre-check
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

    </script>

</body>
</html>